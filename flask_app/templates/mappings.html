{% extends "base.html" %}


{% block title %}端口映射管理{% endblock title %}


{% block main_content %}
    <h2 class="text-primary">共计{{ len(clients) }}个客户端：</h2>
    <br>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>创建时间</th>
                <th>服务端端口</th>
                <th>客户端端口</th>
                <th class="text-center">公网地址</th>
                <th class="text-right">流量统计</th>
                <th class="text-center">相关操作</th>
              </tr>
            </thead>
            <tbody>
            {% for c in clients %}
            {% for p in clients[c]['tcp_maps'] %}
              <tr id="tcp-{{ p }}">
                <td>{{ moment(clients[c]['tcp_maps'][p]['create_time']).format('YYYY-MM-DD HH:mm:ss') }}</td>
                <th scope="row">TCP: {{ p }}</th>
                <td>{{ clients[c]['client_name'] }} (<b>{{ clients[c]['tcp_maps'][p]['client_port'] }}</b>)</td>
                <td class="text-center">{{ clients[c]['tcp_e_addr'] }}</td>
                <td class="text-right">{{ stringify_bytes_val(clients[c]['tcp_maps'][p]['statistic']) }}</td>
                <td class="op-widget-box text-center">
                  <span class="glyphicon glyphicon-{{ 'pause' if clients[c]['tcp_maps'][p]['is_running'] else 'play' }} text-primary" onclick="{{ 'stop_tcp_map' if clients[c]['tcp_maps'][p]['is_running'] else 'start_tcp_map' }}('{{ p }}')"></span>
                  <span class="glyphicon glyphicon-remove text-danger" onclick="remove_tcp_map('{{ p }}')"></span>
                </td>
              </tr>
            {% endfor %}
            {% for p in clients[c]['udp_maps'] %}
              <tr id="udp-{{ p }}">
                <td>{{ moment(clients[c]['udp_maps'][p]['create_time']).format('YYYY-MM-DD HH:mm:ss') }}</td>
                <th scope="row">UDP: {{ p }}</th>
                <td>{{ clients[c]['client_name'] }} (<b>{{ clients[c]['udp_maps'][p]['client_port'] }}</b>)</td>
                <td class="text-center">{{ clients[c]['udp_e_addr'] }}</td>
                <td class="text-right">{{ stringify_bytes_val(clients[c]['udp_maps'][p]['statistic']) }}</td>
                <td class="op-widget-box text-center">
                  <span class="glyphicon glyphicon-{{ 'pause' if clients[c]['udp_maps'][p]['is_running'] else 'play' }} text-primary" onclick="{{ 'stop_udp_map' if clients[c]['udp_maps'][p]['is_running'] else 'start_udp_map' }}('{{ p }}')"></span>
                  <span class="glyphicon glyphicon-remove text-danger" onclick="remove_udp_map('{{ p }}')"></span>
                </td>
              </tr>
            {% endfor %}
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock main_content %}


{% block scripts %}

    {{ super() }}

    <script type="text/javascript">
        function start_tcp_map(server_port) {
            $.get("{{ url_for('api.start_tcp_map', server_port=0) }}".replace(/0/, server_port), function(){
                setTimeout("window.location.reload()", 100);
            });
        }

        function stop_tcp_map(server_port) {
            $.get("{{ url_for('api.stop_tcp_map', server_port=0) }}".replace(/0/, server_port), function(){
                setTimeout("window.location.reload()", 100);
            });
        }

        function remove_tcp_map(server_port) {
            notification_init(
                '提示', '确定删除TCP代理端口（' + server_port + '）？',
                '<button class="btn btn-default" data-dismiss="modal">取消</button><button class="btn btn-danger" onclick="confirm_remove_tcp_map(\'' + server_port + '\')">删除</button>');
            notification_show();
        }

        function confirm_remove_tcp_map(server_port) {
            $.get("{{ url_for('api.remove_tcp_map', server_port=0) }}".replace(/0/, server_port), function(){
                setTimeout("window.location.reload()", 100);
            });
        }

        function start_udp_map(server_port) {
            $.get("{{ url_for('api.start_udp_map', server_port=0) }}".replace(/0/, server_port), function(){
                setTimeout("window.location.reload()", 100);
            });
        }

        function stop_udp_map(server_port) {
            $.get("{{ url_for('api.stop_udp_map', server_port=0) }}".replace(/0/, server_port), function(){
                setTimeout("window.location.reload()", 100);
            });
        }

        function remove_udp_map(server_port) {
            notification_init(
                '提示', '确定删除TCP代理端口（' + server_port + '）？',
                '<button class="btn btn-default" data-dismiss="modal">取消</button><button class="btn btn-danger" onclick="confirm_remove_udp_map(\'' + server_port + '\')">删除</button>');
            notification_show();
        }

        function confirm_remove_udp_map(server_port) {
            $.get("{{ url_for('api.remove_udp_map', server_port=0) }}".replace(/0/, server_port), function(){
                setTimeout("window.location.reload()", 100);
            });
        }
    </script>

{% endblock scripts %}
